name: Android CI/CD Pipeline

on:
  pull_request:
    types: [opened, synchronize, reopened, edited, ready_for_review]
    branches:
      - master
    paths:
      - '**'  # Lint all files in the repository
  push:
    branches:
      - master

permissions:
  pull-requests: write
  contents: write
  security-events: write
  actions: write
  statuses: write
  id-token: write

jobs:
  mega-linter:
    runs-on: ubuntu-latest
    steps:
      # ✅ Step 1: Clear Cache to Ensure Latest Config
      - name: Clear GitHub Actions Cache
        uses: actions/cache@v3
        with:
          path: ~/.cache
          key: ${{ runner.os }}-mega-linter-${{ github.run_id }}
          restore-keys: |
            ${{ runner.os }}-mega-linter

      # ✅ Step 2: Checkout PR branch
      - name: Checkout PR branch
        uses: actions/checkout@v3
        with:
          ref: ${{ github.head_ref }}

      # ✅ Step 3: Debug - List all files in the workspace
      - name: Debug - List All Files in Workspace
        run: |
          echo "🔍 Listing all files in the workspace..."
          ls -al ${{ github.workspace }}
          echo "🔍 Checking inside .github folder..."
          ls -al ${{ github.workspace }}/.github || echo "⚠️ .github folder missing!"
          echo "🔍 Checking inside root directory..."
          ls -al $GITHUB_WORKSPACE

      # ✅ Step 4: Ensure MegaLinter Configuration Files Exist
      - name: Ensure MegaLinter Configurations Exist
        run: |
          echo "🔍 Checking for MegaLinter configuration files..."
          MISSING_FILES=()

          for file in .mega-linter.yml .mega-linter-ignore; do
            if [[ ! -e "$GITHUB_WORKSPACE/$file" ]]; then
              echo "❌ $file is missing! Linter might fail."
              MISSING_FILES+=("$file")
            fi
          done

          if [[ ${#MISSING_FILES[@]} -gt 0 ]]; then
            echo "❌ Missing files: ${MISSING_FILES[*]}"
            exit 1
          fi

          echo "✅ All necessary configuration files exist."

      # ✅ Step 5: Run MegaLinter with explicit config paths and lint all files
      - name: Run MegaLinter on PR changes
        id: mega_linter
        run: |
          echo "🚀 Pulling MegaLinter (latest version)..."
          docker pull megalinter/megalinter:latest  # Pulling the latest image
          echo "🔍 Running MegaLinter..."
          docker run --rm \
            -v ${{ github.workspace }}:/mnt/mega-linter \
            -e GITHUB_WORKSPACE=/mnt/mega-linter \
            -e MEGA_LINTER_CONFIG=/mnt/mega-linter/.mega-linter.yml \
            -e MEGA_LINTER_IGNORE_FILE=/mnt/mega-linter/.mega-linter-ignore \
            -e MEGA_LINTER_REPORT_DIR=/mnt/mega-linter/megalinter-reports \
            megalinter/megalinter:latest --run --ci --log-level DEBUG --linters all --config /mnt/mega-linter/.mega-linter.yml
        continue-on-error: true  # Allow PRs to proceed even if there are errors

      # ✅ Step 6: List Linted Files
      - name: List Linted Files
        run: |
          echo "🔍 Listing all linted files..."
          grep -oP 'linted: \K.*' ${{ github.workspace }}/megalinter-reports/linter-report.txt || echo "⚠️ No linted files found!"

      # ✅ Step 7: List Linter Rules
      - name: List Linter Rules
        run: |
          echo "🔍 Listing all linter rules applied..."
          grep -oP 'rule: \K.*' ${{ github.workspace }}/megalinter-reports/linter-report.txt || echo "⚠️ No linter rules applied!"

      # ✅ Step 8: Upload MegaLinter report as an artifact (Always runs)
      - name: Upload MegaLinter report artifact
        if: always()  # Ensure report is uploaded even if the linter fails
        uses: actions/upload-artifact@v4
        with:
          name: megalinter-report
          path: ${{ github.workspace }}/megalinter-reports  # Make sure this path is correct and reports are generated

      # ✅ Step 9: Comment on PR with MegaLinter results
      - name: Comment on PR with MegaLinter results
        uses: peter-evans/create-or-update-comment@v2
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ### 🔍 MegaLinter Results
            🚀 **Linter results for the pull request:**
            - 📌 **PR Link**: [${{ github.event.pull_request.html_url }}](${{ github.event.pull_request.html_url }})
            - 📄 **MegaLinter Report**: [Linting Report Artifact](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})

      # ✅ Step 10: Approve PR if No Errors
      - name: Approve PR if No Errors
        if: success()
        uses: peter-evans/create-or-update-comment@v2
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ### ✅ MegaLinter Results
            **The PR is ready for approval. All linting issues have been fixed.**
            PR Approved 🎉
