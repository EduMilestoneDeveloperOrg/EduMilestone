name: Android CI/CD Pipeline

on:
  pull_request:
    types: [opened, synchronize, reopened, edited, ready_for_review]
    branches:
      - master
    paths:
      - '**'
  push:
    branches:
      - master

permissions:
  pull-requests: write
  contents: write
  security-events: write
  actions: write
  statuses: write
  id-token: write

jobs:
  mega-linter:
    runs-on: ubuntu-latest
    steps:
      # âœ… Step 1: Clear Cache to Ensure Latest Config
      - name: Clear Cache to Ensure Latest Config
        uses: actions/cache@v3
        with:
          path: ~/.cache
          key: ${{ runner.os }}-mega-linter-${{ github.run_id }}
          restore-keys: |
            ${{ runner.os }}-mega-linter

      # âœ… Step 2: Checkout PR branch
      - name: Checkout PR branch
        uses: actions/checkout@v3
        with:
          ref: ${{ github.head_ref }}

      # âœ… Step 3: Ensure MegaLinter Configurations Are Present
      - name: Ensure MegaLinter Configurations Exist
        run: |
          echo "ğŸ” Checking for MegaLinter configuration files..."
          if [ ! -f ".mega-linter.yml" ]; then
            echo "âŒ .mega-linter.yml is missing! MegaLinter will not use custom configurations."
            exit 1
          fi
          if [ ! -f ".cspell.json" ]; then
            echo "âŒ .cspell.json is missing! Spell check might fail."
            exit 1
          fi
          if [ ! -f ".jscpd.json" ]; then
            echo "âŒ .jscpd.json is missing! Duplicate detection might fail."
            exit 1
          fi
          echo "âœ… All necessary configuration files exist."

      # âœ… Step 4: Debug directory structure
      - name: Debug directory structure
        run: |
          echo "ğŸ” Checking directory structure..."
          ls -al .
          echo "ğŸ” Current working directory: $(pwd)"
          echo "ğŸ” Contents of current directory:"
          ls -al

      # âœ… Step 5: Run MegaLinter with explicit config paths
      - name: Run MegaLinter on PR changes
        id: mega_linter
        run: |
          docker pull megalinter/megalinter:latest
          docker run --rm \
            -v ${{ github.workspace }}:/mnt/mega-linter \
            -e GITHUB_WORKSPACE=/mnt/mega-linter \
            -e MEGA_LINTER_CONFIG=/mnt/mega-linter/.mega-linter.yml \
            -e SPELL_CONFIG_FILE=/mnt/mega-linter/.cspell.json \
            -e JSCOD_CONFIG_FILE=/mnt/mega-linter/.jscpd.json \
            megalinter/megalinter:latest --run --ci --log-level DEBUG
        continue-on-error: true  # Allow PRs to proceed even if there are errors

      # âœ… Step 6: Upload MegaLinter report as an artifact
      - name: Upload MegaLinter report artifact
        if: failure()  # Runs only if MegaLinter fails
        uses: actions/upload-artifact@v4
        with:
          name: megalinter-report
          path: ${{ github.workspace }}/megalinter-reports  # âœ… Updated path

      # âœ… Step 7: Comment on PR with MegaLinter results
      - name: Comment on PR with MegaLinter results
        uses: peter-evans/create-or-update-comment@v2
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ### ğŸ” MegaLinter Results
            ğŸš€ **Linter results for the pull request:**

            - ğŸ“Œ **PR Link**: [${{ github.event.pull_request.html_url }}](${{ github.event.pull_request.html_url }})
            - ğŸ“„ **MegaLinter Report**: [Linting Report Artifact](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})

      # âœ… Step 8: Comment "approved" on PR if all linting checks passed
      - name: Approve PR if No Errors
        if: success()
        uses: peter-evans/create-or-update-comment@v2
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ### âœ… MegaLinter Results
            **The PR is ready for approval. All linting issues have been fixed.**
            PR Approved ğŸ‰
