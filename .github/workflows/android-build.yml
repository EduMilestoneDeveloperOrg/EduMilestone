name: Android CI/CD Pipeline

on:
  pull_request:
    types: [opened, synchronize, reopened, edited, ready_for_review]
    branches:
      - master
    paths:
      - '**'
  push:
    branches:
      - master

permissions:
  pull-requests: write
  contents: write
  security-events: write
  actions: write
  statuses: write
  id-token: write

jobs:
  mega-linter:
    runs-on: ubuntu-latest
    steps:
      # âœ… Step 1: Clear Cache to Ensure Latest Config
      - name: Clear GitHub Actions Cache
        uses: actions/cache@v3
        with:
          path: ~/.cache
          key: ${{ runner.os }}-mega-linter-${{ github.run_id }}
          restore-keys: |
            ${{ runner.os }}-mega-linter

      # âœ… Step 2: Checkout PR branch
      - name: Checkout PR branch
        uses: actions/checkout@v3
        with:
          ref: ${{ github.head_ref }}

      # âœ… Step 3: Debug - List all files in the workspace
      - name: Debug - List All Files in Workspace
        run: |
          echo "ğŸ” Listing all files in the workspace..."
          ls -al ${{ github.workspace }}
          echo "ğŸ” Checking inside .github folder..."
          ls -al ${{ github.workspace }}/.github || echo "âš ï¸ .github folder missing!"
          echo "ğŸ” Checking inside root directory..."
          ls -al $GITHUB_WORKSPACE

      # âœ… Step 4: Run MegaLinter with Detailed Logging
      - name: Run MegaLinter on PR changes
        id: mega_linter
        run: |
          echo "ğŸš€ Pulling MegaLinter (latest version)..."
          docker pull megalinter/megalinter:latest
          echo "ğŸ” Running MegaLinter with detailed logging..."
          docker run --rm \
            -v "${{ github.workspace }}:/mnt/mega-linter" \
            -e GITHUB_WORKSPACE="/mnt/mega-linter" \
            -e MEGA_LINTER_CONFIG="/mnt/mega-linter/.mega-linter.yml" \
            -e MEGA_LINTER_IGNORE_FILE="/mnt/mega-linter/.mega-linter-ignore" \
            -e SPELL_CSPELL_CONFIG_FILE="/mnt/mega-linter/.cspell.json" \
            -e MEGA_LINTER_REPORT_DIR="/mnt/mega-linter/megalinter-reports" \
            -e LOG_LEVEL="TRACE" \
            -e PRINT_LINTERS_TABLE="true" \
            -e PRINT_ALL_FILES="true" \
            -e PRINT_SUMMARY="true" \
            megalinter/megalinter:latest --run --ci --log-level TRACE
        continue-on-error: false

      # âœ… Step 5: List Linted Files
      - name: List Linted Files
        run: |
          echo "ğŸ” Checking if MegaLinter report exists..."
          REPORT_FILE="${{ github.workspace }}/megalinter-reports/linters_logs/linter-report.txt"
          
          if [[ -f "$REPORT_FILE" ]]; then
            echo "ğŸ” Listing all linted files..."
            awk '/linted:/{print $0}' "$REPORT_FILE" || echo "âš ï¸ No linted files found!"
          else
            echo "âš ï¸ MegaLinter report not found at $REPORT_FILE!"
          fi

      # âœ… Step 6: List Linter Rules
      - name: List Linter Rules
        run: |
          echo "ğŸ” Checking if MegaLinter report exists..."
          REPORT_FILE="${{ github.workspace }}/megalinter-reports/linters_logs/linter-report.txt"
          
          if [[ -f "$REPORT_FILE" ]]; then
            echo "ğŸ” Listing all linter rules applied..."
            awk '/rule:/{print $0}' "$REPORT_FILE" || echo "âš ï¸ No linter rules applied!"
          else
            echo "âš ï¸ MegaLinter report not found at $REPORT_FILE!"
          fi

      # âœ… Step 7: Upload MegaLinter report as an artifact (Always runs)
      - name: Upload MegaLinter report artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: megalinter-report
          path: ${{ github.workspace }}/megalinter-reports  # Ensure this path is correct

      # âœ… Step 8: Comment on PR with MegaLinter results
      - name: Comment on PR with MegaLinter results
        uses: peter-evans/create-or-update-comment@v2
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ### ğŸ” MegaLinter Results
            ğŸš€ **Linter results for the pull request:**
            - ğŸ“Œ **PR Link**: [${{ github.event.pull_request.html_url }}](${{ github.event.pull_request.html_url }})
            - ğŸ“„ **MegaLinter Report**: [Linting Report Artifact](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})

      # âœ… Step 9: Approve PR if No Errors
      - name: Approve PR if No Errors
        if: success()
        uses: peter-evans/create-or-update-comment@v2
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ### âœ… MegaLinter Results
            **The PR is ready for approval. All linting issues have been fixed.**
            PR Approved ğŸ‰
