name: Android CI/CD Pipeline

# ğŸš€ Features Included in the CI/CD Pipeline
# ğŸš§ PR Restriction: Ensures only repository collaborators/members can raise PRs.
# ğŸ›¡ï¸ Security Scan (CodeQL): Runs CodeQL security analysis.
# ğŸ” Dependency Scan (Trivy): Scans dependencies for vulnerabilities.
# ğŸ¤– AI Code Review (Copilot): Enforces GitHub Copilot AI review on PRs.
# ğŸ“œ PR Description Enforcement: Ensures meaningful PR descriptions.
# ğŸ“‘ PR File Limit Enforcement: Restricts PRs modifying too many files.
# ğŸ¨ Linting (ktlint): Enforces Kotlin coding standards.
# âœ… Organization Owner Approval: Requires manual approval from the repository owner.
# ğŸš€ Build & APK Generation: Compiles the project and generates an APK.
# ğŸ§ª Unit Testing: Runs unit tests (optional but recommended).
# âœ… Final Merge Check: Ensures that all required jobs pass before PR approval.
# ğŸ”„ Fail-Fast Strategy: Prevents unnecessary job execution if a critical job fails.
# â³ Timeout Enforcement: Limits execution time to prevent long-running jobs.
# â™»ï¸ Resource Cleanup: Ensures that workspaces are cleaned after execution.
# ğŸ“¢ Notifications: Sends alerts in case of failures (Slack, email, etc.).
# ğŸ” Retry Mechanism: Retries transient failures automatically.
# âš¡ Parallelization: Runs independent jobs concurrently to speed up execution.
# ğŸ“¦ Dependency Caching: Caches Gradle dependencies to optimize build speed.


on:
  pull_request:
    types: [opened, synchronize, reopened, edited, ready_for_review]
    branches:
      - master
    paths:
      - '**'
  push:
    branches:
      - master

permissions:
  pull-requests: write
  contents: write
  security-events: write  # Required for CodeQL scanning
  actions: write
  statuses: write
  id-token: write

jobs:
  mega-linter:
    runs-on: ubuntu-latest
    steps:
      # Step 1: Checkout the PR branch
      - name: Checkout PR branch
        uses: actions/checkout@v3
        with:
          ref: ${{ github.head_ref }}
  
      # Step 2: Debug: Check directory structure and current working directory
      - name: Debug directory structure
        run: |
          echo "ğŸ” Checking directory structure..."
          ls -al .
          echo "ğŸ” Current working directory: $(pwd)"
          echo "ğŸ” Contents of current directory:"
          ls -al
  
      # Step 3: Run MegaLinter on PR changes
      - name: Run MegaLinter on PR changes
        run: |
          docker pull megalinter/megalinter:latest
          docker run --rm \
            -v ${{ github.workspace }}:/mnt/mega-linter \
            -e GITHUB_WORKSPACE=/mnt/mega-linter \
            megalinter/megalinter:latest --run --ci --disable=all --workspace /mnt/mega-linter --changed
  
      # Step 4: Upload MegaLinter report as an artifact
      - name: Upload MegaLinter report artifact
        uses: actions/upload-artifact@v4
        with:
          name: megalinter-report
          path: /tmp/lint/report/linters_logs
  
      # Step 5: Comment on PR with MegaLinter results
      - name: Comment on PR with MegaLinter results
        uses: peter-evans/create-or-update-comment@v2
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ### MegaLinter Results
            Linter results for the pull request:
  
            PR Link: [${{ github.event.pull_request.html_url }}](${{ github.event.pull_request.html_url }})
  
            You can find the full MegaLinter report here: [Linting Report Artifact](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) for fixing.
  
      # Step 6: Comment "approved" on PR if all linting checks passed
      - name: Comment approved on PR
        if: success()
        uses: peter-evans/create-or-update-comment@v2
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ### MegaLinter Results
            The PR is ready for approval. All linting issues have been fixed.
  
            **PR has been approved**. âœ…
