name: Android CI/CD Pipeline

# ðŸš€ Features Included in the CI/CD Pipeline
# ðŸš§ PR Restriction: Ensures only repository collaborators/members can raise PRs.
# ðŸ›¡ï¸ Security Scan (CodeQL): Runs CodeQL security analysis.
# ðŸ” Dependency Scan (Trivy): Scans dependencies for vulnerabilities.
# ðŸ¤– AI Code Review (Copilot): Enforces GitHub Copilot AI review on PRs.
# ðŸ“œ PR Description Enforcement: Ensures meaningful PR descriptions.
# ðŸ“‘ PR File Limit Enforcement: Restricts PRs modifying too many files.
# ðŸŽ¨ Linting (ktlint): Enforces Kotlin coding standards.
# âœ… Organization Owner Approval: Requires manual approval from the repository owner.
# ðŸš€ Build & APK Generation: Compiles the project and generates an APK.
# ðŸ§ª Unit Testing: Runs unit tests (optional but recommended).
# âœ… Final Merge Check: Ensures that all required jobs pass before PR approval.
# ðŸ”„ Fail-Fast Strategy: Prevents unnecessary job execution if a critical job fails.
# â³ Timeout Enforcement: Limits execution time to prevent long-running jobs.
# â™»ï¸ Resource Cleanup: Ensures that workspaces are cleaned after execution.
# ðŸ“¢ Notifications: Sends alerts in case of failures (Slack, email, etc.).
# ðŸ” Retry Mechanism: Retries transient failures automatically.
# âš¡ Parallelization: Runs independent jobs concurrently to speed up execution.
# ðŸ“¦ Dependency Caching: Caches Gradle dependencies to optimize build speed.


on:
  pull_request:
    types: [opened, synchronize, reopened, edited, ready_for_review]
    branches:
      - master
    paths:
      - '**'
  push:
    branches:
      - master

permissions:
  pull-requests: write
  contents: write
  security-events: write  # Required for CodeQL scanning
  actions: write

jobs:
# 1ï¸âƒ£ Pre-Checks & PR Validation (No dependencies)
  pr_restriction:
    name: ðŸš§ Enforce PR Restrictions
    runs-on: ubuntu-latest
  
    steps:
      - name: ðŸ” Debug & Verify PR Author
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ðŸ” Starting PR Debugging..."
          echo "ðŸ”¹ GitHub Event: ${{ github.event_name }}"
          echo "ðŸ”¹ Repository: ${{ github.repository }}"
          echo "ðŸ”¹ Actor: ${{ github.actor }}"
          echo "ðŸ”¹ Action: ${{ github.event.action }}"
          echo "ðŸ”¹ PR Number: ${{ github.event.pull_request.number }}"
          echo "ðŸ”¹ PR URL: ${{ github.event.pull_request.html_url }}"
          
          echo "ðŸ” Extracting PR Number..."
          PR_NUMBER="${{ github.event.pull_request.number }}"
          REPO_NAME="${{ github.repository }}"
  
          if [[ -z "$PR_NUMBER" || "$PR_NUMBER" == "null" ]]; then
            echo "âŒ ERROR: PR number is missing or invalid."
            exit 1
          fi
  
          echo "ðŸ”¹ Extracted PR Number: '$PR_NUMBER'"
          echo "ðŸ”¹ Repository: $REPO_NAME"
  
          echo "ðŸ” Checking GitHub Token Authentication..."
          gh auth status || { echo "âŒ GH_TOKEN authentication failed!"; exit 1; }
  
          echo "ðŸ” Fetching PR Author..."
          PR_USER=$(curl -s -H "Authorization: token $GH_TOKEN" \
            "https://api.github.com/repos/$REPO_NAME/pulls/$PR_NUMBER" | jq -r '.user.login')
  
          if [[ -z "$PR_USER" || "$PR_USER" == "null" ]]; then
            echo "âŒ ERROR: Failed to retrieve PR author."
            echo "   - PR number may be incorrect"
            echo "   - GH_TOKEN may lack permissions"
            echo "   - Repository may be private"
            exit 1
          fi
  
          echo "âœ… PR Author: $PR_USER"
  
          echo "ðŸ” Checking if PR author is a collaborator or member..."
          COLLABORATOR_STATUS=$(curl -s -o /dev/null -w "%{http_code}" -H "Authorization: token $GH_TOKEN" \
            "https://api.github.com/repos/$REPO_NAME/collaborators/$PR_USER")
  
          if [[ "$COLLABORATOR_STATUS" -ne 204 ]]; then
            echo "âŒ ERROR: Only repository collaborators or members can raise pull requests!"
            exit 1
          fi
  
          echo "âœ… PR is from an authorized collaborator or member."

  enforce_pr_description:
    name: ðŸ“œ Enforce PR Description
    runs-on: ubuntu-latest
    needs: [pr_restriction]
    steps:
      - name: ðŸ” Check PR Description
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Extract pull request number
          PR_NUMBER="${{ github.event.pull_request.number }}"
          REPO_NAME="${{ github.repository }}"
  
          if [[ -z "$PR_NUMBER" || "$PR_NUMBER" == "null" ]]; then
            echo "âŒ ERROR: Invalid PR number. Cannot check description."
            exit 1
          fi
  
          # Retrieve the PR description using curl
          DESCRIPTION=$(curl -s -H "Authorization: token $GH_TOKEN" \
            "https://api.github.com/repos/$REPO_NAME/pulls/$PR_NUMBER" | jq -r '.body')
  
          # Debugging: Show raw description for clarity
          echo "ðŸ” Raw PR Description:"
          echo "$DESCRIPTION"
  
          # Ensure description retrieval succeeded
          if [[ -z "$DESCRIPTION" || "$DESCRIPTION" == "null" ]]; then
            echo "âŒ ERROR: PR must have a meaningful description!"
            exit 1
          fi
  
          # Trim whitespace and check if the description is empty
          TRIMMED_DESC=$(echo "$DESCRIPTION" | xargs)
  
          if [[ -z "$TRIMMED_DESC" ]]; then
            echo "âŒ ERROR: PR description cannot be empty or only spaces!"
            exit 1
          fi
          
          echo "âœ… PR has a valid description."

  enforce_pr_files_limit:
    name: ðŸ“‘ Limit PR File Changes (Max 50)
    runs-on: ubuntu-latest
    needs: [enforce_pr_description]
    steps:
      - name: ðŸ” Check Number of Files Changed
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Extract pull request number and repository name
          PR_NUMBER="${{ github.event.pull_request.number }}"
          REPO_NAME="${{ github.repository }}"
  
          if [[ -z "$PR_NUMBER" || "$PR_NUMBER" == "null" ]]; then
            echo "âŒ ERROR: Invalid PR number. Cannot check file count."
            exit 1
          fi
  
          # Fetch list of changed files using GitHub API
          RESPONSE=$(curl -s -H "Authorization: token $GH_TOKEN" \
            "https://api.github.com/repos/$REPO_NAME/pulls/$PR_NUMBER/files")
  
          # Debugging: Print the API response for troubleshooting
          echo "ðŸ” API Response:"
          echo "$RESPONSE"
  
          # Extract file count
          FILE_COUNT=$(echo "$RESPONSE" | jq 'length' 2>/dev/null || echo "")
  
          # Ensure FILE_COUNT is valid and numeric
          if ! [[ "$FILE_COUNT" =~ ^[0-9]+$ ]]; then
            echo "âŒ ERROR: Unable to determine the number of changed files."
            exit 1
          fi
  
          # Verify if the number of files changed exceeds the limit
          if [[ "$FILE_COUNT" -gt 50 ]]; then
            echo "âŒ ERROR: PR modifies too many files ($FILE_COUNT). Please split into smaller PRs."
            exit 1
          fi
          
          echo "âœ… PR modifies $FILE_COUNT files, within the allowed limit."
  security_scan:
    name: ðŸ›¡ï¸ Trigger & Wait for CodeQL
    runs-on: ubuntu-latest
    needs: [enforce_pr_files_limit]
    steps:
      - name: ðŸ›Žï¸ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸš€ Trigger CodeQL Workflow
        id: trigger_codeql
        run: |
          echo "ðŸ”¹ Triggering CodeQL workflow..."
          RESPONSE=$(curl -s -X POST -H "Authorization: token ${{ secrets.PAT_GITHUB_ACTIONS }}" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/${{ github.repository }}/actions/workflows/codeql.yml/dispatches \
            -d '{"ref":"${{ github.ref }}"}')

          HTTP_STATUS=$(echo "$RESPONSE" | jq -r '.status // empty')
          if [[ "$HTTP_STATUS" != "204" && -z "$HTTP_STATUS" ]]; then
            echo "âŒ Failed to trigger CodeQL workflow. Response:"
            echo "$RESPONSE" | jq .
            exit 1
          fi
          echo "âœ… CodeQL workflow triggered successfully."

      - name: â³ Wait for CodeQL to Complete (Max 15 min)
        run: |
          MAX_RETRIES=45  # 45 * 20s = 15 minutes max
          COUNT=0
          RUN_ID=""

          echo "ðŸ” Waiting for CodeQL workflow to start..."
          while [[ -z "$RUN_ID" && "$COUNT" -lt "$MAX_RETRIES" ]]; do
            RESPONSE=$(curl -s -H "Authorization: token ${{ secrets.PAT_GITHUB_ACTIONS }}" \
              -H "Accept: application/vnd.github.v3+json" \
              https://api.github.com/repos/${{ github.repository }}/actions/runs)

            RUN_ID=$(echo "$RESPONSE" | jq -r '.workflow_runs[] | select(.name=="CodeQL Ultimate Security Scan") | .id' | head -n 1)

            if [[ -z "$RUN_ID" || "$RUN_ID" == "null" ]]; then
              echo "âš ï¸ CodeQL run not found yet. Retrying... ($COUNT/$MAX_RETRIES)"
              COUNT=$((COUNT+1))
              sleep 20
            else
              echo "âœ… Found CodeQL workflow run: ID=$RUN_ID"
            fi
          done

          if [[ -z "$RUN_ID" || "$RUN_ID" == "null" ]]; then
            echo "âŒ CodeQL workflow did not start within 15 minutes."
            exit 1
          fi

          COUNT=0
          while [[ "$COUNT" -lt "$MAX_RETRIES" ]]; do
            STATUS=$(curl -s -H "Authorization: token ${{ secrets.PAT_GITHUB_ACTIONS }}" \
              -H "Accept: application/vnd.github.v3+json" \
              https://api.github.com/repos/${{ github.repository }}/actions/runs/$RUN_ID \
              | jq -r '.status')

            echo "ðŸ”„ Current CodeQL Status: $STATUS"

            if [[ "$STATUS" == "completed" ]]; then
              CONCLUSION=$(curl -s -H "Authorization: token ${{ secrets.PAT_GITHUB_ACTIONS }}" \
                -H "Accept: application/vnd.github.v3+json" \
                https://api.github.com/repos/${{ github.repository }}/actions/runs/$RUN_ID \
                | jq -r '.conclusion')

              echo "ðŸ” CodeQL Scan Conclusion: $CONCLUSION"

              if [[ "$CONCLUSION" == "success" ]]; then
                echo "âœ… CodeQL scan passed. Continuing pipeline..."
                exit 0
              else
                echo "âŒ CodeQL scan failed! Blocking merge."

                # Fetch failure details safely
                FAILURE_RESPONSE=$(curl -s -H "Authorization: token ${{ secrets.PAT_GITHUB_ACTIONS }}" \
                  -H "Accept: application/vnd.github.v3+json" \
                  https://api.github.com/repos/${{ github.repository }}/actions/runs/$RUN_ID/jobs)

                echo "ðŸ“ Raw Failure Response:"
                echo "$FAILURE_RESPONSE" | jq .

                if jq -e . >/dev/null 2>&1 <<<"$FAILURE_RESPONSE"; then
                  FAILURE_REASON=$(echo "$FAILURE_RESPONSE" | jq -r '
                    if .jobs then
                      [.jobs[] | select(.status=="completed" and .conclusion=="failure") | {name: .name, failure_message: (.steps[].name // "Unknown failure")}]
                    else
                      "No failure details found"
                    end' || echo "Unknown error")
                else
                  FAILURE_REASON="Invalid JSON received from GitHub API"
                fi

                echo "ðŸš¨ Failure Details: $FAILURE_REASON"

                exit 1
              fi
            fi

            echo "â³ CodeQL is still running... ($COUNT/$MAX_RETRIES retries)"
            COUNT=$((COUNT+1))
            sleep 20
          done

          echo "âŒ Timeout! CodeQL scan did not finish within 15 minutes."
          exit 1
