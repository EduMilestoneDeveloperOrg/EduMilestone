name: Android CI/CD Pipeline

on:
  pull_request:
    types: [opened, synchronize, reopened, edited, ready_for_review]
    branches:
      - master
    paths:
      - '**'
  push:
    branches:
      - master

permissions:
  pull-requests: write
  contents: write
  security-events: write
  actions: write
  statuses: write
  id-token: write

jobs:
  mega-linter:
    runs-on: ubuntu-latest
    steps:
      # âœ… Step 1: Clear Cache to Ensure Latest Config
      - name: Clear GitHub Actions Cache
        uses: actions/cache@v3
        with:
          path: ~/.cache
          key: ${{ runner.os }}-mega-linter-${{ github.run_id }}
          restore-keys: |
            ${{ runner.os }}-mega-linter

      # âœ… Step 2: Checkout PR branch
      - name: Checkout PR branch
        uses: actions/checkout@v3
        with:
          ref: ${{ github.head_ref }}

      # âœ… Step 3: Debug - List all files in the workspace
      - name: Debug - List All Files in Workspace
        run: |
          echo "ğŸ” Listing all files in the workspace..."
          ls -al ${{ github.workspace }}
          echo "ğŸ” Checking inside .github folder..."
          ls -al ${{ github.workspace }}/.github || echo "âš ï¸ .github folder missing!"
          echo "ğŸ” Checking inside root directory..."
          ls -al $GITHUB_WORKSPACE

      # âœ… Step 4: Run MegaLinter with Reduced Logging
      - name: MegaLinter
        uses: oxsecurity/megalinter@v8.4.2
        env:
          GITHUB_WORKSPACE: "/mnt/mega-linter"
          MEGA_LINTER_CONFIG: "/mnt/mega-linter/.mega-linter.yml"
          MEGA_LINTER_IGNORE_FILE: "/mnt/mega-linter/.mega-linter-ignore"
          SPELL_CSPELL_CONFIG_FILE: "/mnt/mega-linter/.cspell.json"
          MEGA_LINTER_REPORT_DIR: "/mnt/mega-linter/megalinter-reports"
          LOG_LEVEL: "INFO"  # âœ… Less logs, keeps necessary info
          PRINT_LINTERS_TABLE: "false"  # âœ… Disable linter list
          PRINT_ALL_FILES: "false"  # âœ… Disable full file list in logs
          PRINT_SUMMARY: "true"  # âœ… Keep summary for quick review
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PRINT_SUMMARY: true
          LOG_LEVEL: INFO
          MEGA_LINTER_CONFIG: .mega-linter.yml
          filter_regex_exclude: ".*(test|androidTest).*"
     
      # âœ… Step 5: Verify MegaLinter Reports Before Uploading
      - name: Check MegaLinter Reports
        run: |
          REPORT_PATH="${{ github.workspace }}/megalinter-reports"
          if [ -d "$REPORT_PATH" ]; then
            echo "âœ… MegaLinter reports found, proceeding with upload."
          else
            echo "âš ï¸ No reports found! Skipping upload."
            exit 1
          fi

      # âœ… Step 6: Upload MegaLinter Report Artifact
      - name: Upload MegaLinter report artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: megalinter-report
          path: ${{ github.workspace }}/megalinter-reports

      # âœ… Step 7: Comment on PR with MegaLinter Results
      - name: Comment on PR with MegaLinter results
        uses: peter-evans/create-or-update-comment@v2
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ### ğŸ” MegaLinter Results
            ğŸš€ **Linter results for the pull request:**
            - ğŸ“Œ **PR Link**: [${{ github.event.pull_request.html_url }}](${{ github.event.pull_request.html_url }})
            - ğŸ“„ **MegaLinter Report**: [Linting Report Artifact](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})

      # âœ… Step 8: Approve PR if No Errors
      - name: Approve PR if No Errors
        if: success()
        uses: peter-evans/create-or-update-comment@v2
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ### âœ… MegaLinter Results
            **The PR is ready for approval. All linting issues have been fixed.**
            PR Approved ğŸ‰
