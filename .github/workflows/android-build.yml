name: Android CI/CD Pipeline

# ðŸš€ Features Included in the CI/CD Pipeline
# ðŸš§ PR Restriction: Ensures only repository collaborators/members can raise PRs.
# ðŸ›¡ï¸ Security Scan (CodeQL): Runs CodeQL security analysis.
# ðŸ” Dependency Scan (Trivy): Scans dependencies for vulnerabilities.
# ðŸ¤– AI Code Review (Copilot): Enforces GitHub Copilot AI review on PRs.
# ðŸ“œ PR Description Enforcement: Ensures meaningful PR descriptions.
# ðŸ“‘ PR File Limit Enforcement: Restricts PRs modifying too many files.
# ðŸŽ¨ Linting (ktlint): Enforces Kotlin coding standards.
# âœ… Organization Owner Approval: Requires manual approval from the repository owner.
# ðŸš€ Build & APK Generation: Compiles the project and generates an APK.
# ðŸ§ª Unit Testing: Runs unit tests (optional but recommended).
# âœ… Final Merge Check: Ensures that all required jobs pass before PR approval.
# ðŸ”„ Fail-Fast Strategy: Prevents unnecessary job execution if a critical job fails.
# â³ Timeout Enforcement: Limits execution time to prevent long-running jobs.
# â™»ï¸ Resource Cleanup: Ensures that workspaces are cleaned after execution.
# ðŸ“¢ Notifications: Sends alerts in case of failures (Slack, email, etc.).
# ðŸ” Retry Mechanism: Retries transient failures automatically.
# âš¡ Parallelization: Runs independent jobs concurrently to speed up execution.
# ðŸ“¦ Dependency Caching: Caches Gradle dependencies to optimize build speed.


on:
  pull_request:
    types: [opened, synchronize, reopened, edited, ready_for_review]
    branches:
      - master
    paths:
      - '**'
  push:
    branches:
      - master

permissions:
  pull-requests: write
  contents: write
  security-events: write  # Required for CodeQL scanning
  actions: write
  statuses: write
  id-token: write

jobs:
  mega-linter:
    runs-on: ubuntu-latest
    permissions:
      contents: read  # To access the repository contents
      pull-requests: write  # To comment on PRs

    steps:
    # Step 1: Checkout the repository code (first time on base branch)
    - name: Checkout code (base branch)
      uses: actions/checkout@v3
      with:
        ref: master  # or 'main'

    # Step 2: Install MegaLinter using Docker
    - name: Install MegaLinter (base codebase)
      run: |
        docker pull megalinter/megalinter:latest
        docker run --rm -v $(pwd):/mnt/mega-linter megalinter/megalinter:latest --run --ci --disable=all --workspace /mnt/mega-linter

    # Step 3: Fetch PR details (PR number, PR link)
    - name: Fetch PR details
      id: pr_details
      run: |
        PR_NUMBER=$(echo ${GITHUB_REF} | cut -d'/' -f3)
        PR_LINK="https://github.com/${GITHUB_REPOSITORY}/pull/${PR_NUMBER}"
        echo "PR_NUMBER=${PR_NUMBER}" >> $GITHUB_ENV
        echo "PR_LINK=${PR_LINK}" >> $GITHUB_ENV
        echo "PR details: PR_NUMBER=${PR_NUMBER}, PR_LINK=${PR_LINK}"

    # Step 4: Checkout the PR branch to check the PR changes
    - name: Checkout PR branch
      uses: actions/checkout@v3
      with:
        ref: ${{ github.head_ref }}

    # Step 5: Run MegaLinter only on the PR changes (compared to master)
    - name: Run MegaLinter on PR changes
      run: |
        docker pull megalinter/megalinter:latest
        docker run --rm -v $(pwd):/mnt/mega-linter megalinter/megalinter:latest --run --ci --disable=all --workspace /mnt/mega-linter --changed

    # Step 6: Upload MegaLinter report as an artifact (for future review)
    - name: Upload MegaLinter report artifact
      uses: actions/upload-artifact@v3
      with:
        name: megalinter-report
        path: /tmp/lint/report/linters_logs

    # Step 7: Comment on PR with MegaLinter results
    - name: Comment on PR with MegaLinter results
      uses: peter-evans/create-or-update-comment@v2
      with:
        issue-number: ${{ env.PR_NUMBER }}
        body: |
          ### MegaLinter Results
          Linter results for the pull request:

          PR Link: [${{ env.PR_LINK }}](${{env.PR_LINK }})

          You can find the full MegaLinter report here: [Linting Report Artifact](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) for fixing.

    # Step 8: Comment "approved" if everything looks good
    - name: Comment approved on PR
      if: success()
      uses: peter-evans/create-or-update-comment@v2
      with:
        issue-number: ${{ env.PR_NUMBER }}
        body: |
          ### MegaLinter Results
          The PR is ready for approval. All linting issues have been fixed.

          **PR has been approved**. âœ…
