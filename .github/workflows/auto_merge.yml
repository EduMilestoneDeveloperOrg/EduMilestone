name: ğŸ”„ ğŸš€ Auto Merge (Merge Queue)

on:
  workflow_dispatch:  # Manually triggered workflow
  merge_group:  # Trigger when PRs enter the merge queue
  push:  # Exclude push events
    paths-ignore:
      - '**'
  pull_request:
    types:
      - opened  # Exclude new pull request events
    paths-ignore:
      - '**'

jobs:
  auto_merge:
    name: ğŸ”„ ğŸš€ Auto Merge PR (Squash & Merge)
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ› ï¸ Debug: Print Environment Variables
        run: |
          echo "ğŸ” GitHub Event Name: ${{ github.event_name }}"
          echo "ğŸ” PR Number: ${{ github.event.pull_request.number }}"
          echo "ğŸ” Merge SHA: ${{ github.sha }}"

      - name: ğŸ” Checking Merge Queue Readiness
        run: |
          echo "ğŸ” Checking if PR is ready for merge queue..."
          PR_NUMBER="${{ github.event.pull_request.number }}"
          MAX_ATTEMPTS=5
          ATTEMPT=1
          SLEEP_INTERVAL=120  # 2 minutes

          while [[ "$ATTEMPT" -le "$MAX_ATTEMPTS" ]]; do
            echo "ğŸ”„ Checking PR mergeability (Attempt $ATTEMPT)..."
            
            # Fetch PR merge state
            MERGE_QUEUE_STATE=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/repos/${{ github.repository }}/pulls/$PR_NUMBER" \
              | jq -r '.mergeable_state')

            echo "ğŸ” PR Merge Queue State: $MERGE_QUEUE_STATE"

            if [[ "$MERGE_QUEUE_STATE" == "clean" ]]; then
              echo "âœ… PR is mergeable and ready for merging."
              break
            elif [[ "$MERGE_QUEUE_STATE" == "dirty" ]]; then
              echo "âŒ PR has merge conflicts. Merge will not proceed."
              exit 1
            elif [[ "$MERGE_QUEUE_STATE" == "unstable" ]]; then
              echo "â³ PR is still 'unstable'. Retrying in $SLEEP_INTERVAL seconds..."
              sleep $SLEEP_INTERVAL
            fi

            ATTEMPT=$((ATTEMPT + 1))
          done

          if [[ "$ATTEMPT" -gt "$MAX_ATTEMPTS" ]]; then
            echo "âŒ PR remained 'unstable' after multiple attempts. Skipping merge."
            exit 1
          fi

      - name: ğŸ”„ Squash & Merge PR
        run: |
          echo "âœ… PR is confirmed in the merge queue. Proceeding with squash & merge..."
          PR_NUMBER="${{ github.event.pull_request.number }}"
          RESPONSE=$(curl -s -o response.json -w "%{http_code}" -X PUT \
            "https://api.github.com/repos/${{ github.repository }}/pulls/$PR_NUMBER/merge" \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -d '{"commit_title": "ğŸ”„ Auto-merged by CI", "merge_method": "squash"}')

          if [[ "$RESPONSE" -ne 200 ]]; then
            echo "âŒ Merge request failed! Response:"
            cat response.json
            exit 1
          fi

          echo "âœ… Auto Merge completed successfully."
