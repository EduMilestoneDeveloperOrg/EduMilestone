name: Auto Merge
on:
  merge_group:
    branches:
      - master  # Adjust for your main branch

jobs:
  merge_pr:
    runs-on: ubuntu-latest
    steps:
      - name: 🚀 Merge PR via GitHub API
        run: |
          echo "🔍 Fetching PR details..."
          PR_NUMBER=$(curl -s -H "Authorization: token ${{ secrets.PAT_GITHUB }}" \
            "https://api.github.com/repos/${{ github.repository }}/pulls?state=open&sort=updated&direction=desc" | jq -r '.[0].number')

          if [[ -z "$PR_NUMBER" || "$PR_NUMBER" == "null" ]]; then
            echo "❌ No open PR found!"
            exit 1
          fi

          echo "🚀 Merging PR #$PR_NUMBER..."
          gh pr merge $PR_NUMBER --squash --auto -R ${{ github.repository }}

          echo "❌ PR did not merge within the expected time. Manual intervention required."
          exit 1
